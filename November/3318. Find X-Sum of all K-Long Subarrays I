class Solution {
  private int windowSum = 0;

  public int[] findXSum(int[] nums, int k, int x) {
    int[] ans = new int[nums.length - k + 1];
    Map<Integer, Integer> count = new HashMap<>();
    TreeSet<Pair<Integer, Integer>> top = new TreeSet<>(
        Comparator.<Pair<Integer, Integer>, Integer>comparing(Pair::getKey)
            .thenComparing(Pair::getValue));
    TreeSet<Pair<Integer, Integer>> bot = new TreeSet<>(
        Comparator.<Pair<Integer, Integer>, Integer>comparing(Pair::getKey)
            .thenComparing(Pair::getValue));

    for (int i = 0; i < nums.length; ++i) {
      update(nums[i], 1, count, top, bot);
      if (i >= k) {
        update(nums[i - k], -1, count, top, bot);
      }

      while (!bot.isEmpty() && top.size() < x) {
        Pair<Integer, Integer> pair = bot.pollLast();
        top.add(pair);
        windowSum += pair.getValue() * pair.getKey();
      }

      while (!bot.isEmpty() && !top.isEmpty() &&
             (bot.last().getKey() > top.first().getKey() ||
              (bot.last().getKey().equals(top.first().getKey()) &&
               bot.last().getValue() > top.first().getValue()))) {
        Pair<Integer, Integer> pairB = bot.pollLast();
        Pair<Integer, Integer> pairT = top.pollFirst();
        top.add(pairB);
        bot.add(pairT);
        windowSum += pairB.getValue() * pairB.getKey();
        windowSum -= pairT.getValue() * pairT.getKey();
      }

      if (i >= k - 1) {
        ans[i - k + 1] = windowSum;
      }
    }
    return ans;
  }

  private void update(int num, int freq, Map<Integer, Integer> count,
                      TreeSet<Pair<Integer, Integer>> top,
                      TreeSet<Pair<Integer, Integer>> bot) {
    if (count.getOrDefault(num, 0) > 0) {
      Pair<Integer, Integer> pair = new Pair<>(count.get(num), num);
      if (!bot.remove(pair)) {
        top.remove(pair);
        windowSum -= num * count.get(num);
      }
    }

    count.merge(num, freq, Integer::sum);

    if (count.get(num) > 0) {
      bot.add(new Pair<>(count.get(num), num));
    }
  }
}
